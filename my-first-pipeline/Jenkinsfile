pipeline {
  agent {
    docker { 
      image 'ubuntu:22.04' // Specify the desired Ubuntu version
      args '-u root' // Run the container as root
    }
  }
  environment {
    GIT_URL = 'https://github.com/Simha4820/plugins.git'
    APP_FILE = 'app.js' // Adjust this if the file name is different
  }
  stages {
    stage('Checkout Code') {
      steps {
        // Checkout the app from GitHub
        git branch: 'main', url: "${GIT_URL}"
      }
    }
    stage('Install Node.js and curl') {
      steps {
        // Update package list and install Node.js, npm, and curl
        sh '''
          apt-get update
          apt-get install -y curl
          curl -fsSL https://deb.nodesource.com/setup_16.x | bash -
          apt-get install -y nodejs
        '''
      }
    }
    
    stage('Test') {
      steps {
        // Check Node.js version
        sh 'node --version'
      }
    }
    stage('Run App') {
      steps {
        // Run the app in detached mode
        sh "nohup node ${APP_FILE} > app.log 2>&1 &"
        
        // Optional: Wait a few seconds for the app to start
        sleep(time: 5, unit: 'SECONDS')
        
        // Check if app is working by making a request
        sh "curl http://localhost:3000"
      }
    }
  }
}
